#!/usr/bin/env ruby

require_relative './lib/server'
require_relative './lib/paradise/exception'

FILENAME   = '.world.teapot.yaml'.freeze
USE_COLORS = true

begin
  require 'colorize'
  raise LoadError unless USE_COLORS

  PROMPT   = '∴ '.yellow
  RESPONSE = '» '.yellow
  ERROR    = '! '.red
rescue LoadError
  PROMPT   = '∴ '.freeze
  RESPONSE = '» '.freeze
  ERROR    = '! '.freeze
end

world = if File.exist? FILENAME
          Paradise::World.load File.open(FILENAME, 'r')
        else
          Paradise::World.default
        end

server = Paradise::Server.new world
vessel = 0

$stdout.print PROMPT

begin
  $stdin.each_line do |line|
    result = server.query vessel, line

    if result.is_a? Paradise::ParadiseException
      $stdout.print ERROR
      $stdout.print result.human_readable
    else
      $stdout.print RESPONSE
      $stdout.print result
    end

    $stdout.print "\n"
    $stdout.print PROMPT
  end
rescue Interrupt
  puts "\nSaving world..."
  File.open(FILENAME, 'w') do |f|
    server.world.dump f
  end
  $stdout.print 'Saved'
ensure
  puts
end
