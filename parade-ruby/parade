#!/usr/bin/env ruby

require 'colorize'
require_relative './lib/server'
require_relative './lib/paradise/exception'

filename = '.world.teapot.yaml'

world = if File.exist? filename
          Paradise::World.load File.open(filename, 'r')
        else
          Paradise::World.default
        end

server = Paradise::Server.new world
vessel = 0

$stdout.print '∴ '.yellow

begin
  $stdin.each_line do |line|
    result = server.query vessel, line

    if result.is_a? Paradise::ParadiseException
      $stdout.print '» '.red
      $stdout.print result.human_readable
    else
      $stdout.print '» '.yellow
      $stdout.print result
    end

    $stdout.print "\n∴ ".yellow
  end
rescue Interrupt
  puts "\nSaving world..."
  File.open(filename, 'w') do |f|
    server.world.dump f
  end
  $stdout.print 'Saved'
ensure
  puts
end
